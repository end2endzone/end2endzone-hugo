{{/* layouts/shortcodes/image-caption.html */}}

{{- /* 1. Raw inner HTML, trimmed */ -}}
{{- $raw := .Inner | markdownify | strings.TrimSpace | safeHTML -}}

{{- /* 2. Regex patterns */ -}}
{{- $anchorRE := `(?s)<a[^>]*>.*?<\/a>` -}}
{{- $imgRE    := `<img[^>]*>` -}}

{{- /* 3. Find all <a>â€¦</a> and <img> matches */ -}}
{{- $anchors := findRE $anchorRE $raw -}}
{{- $imgs    := findRE $imgRE    $raw -}}

{{- /* 4. Decide whether we have a linked image */ -}}
{{- $hasAnchor := gt (len $anchors) 0 -}}

{{- /* 5. Pick the "figure element" to be the first anchor or the first img */ -}}
{{- $figureElem := cond $hasAnchor (index $anchors 0) (index $imgs 0) -}}

{{- /* 6. Strip that element out to form the caption text */ -}}
{{- $captionHTML := cond
     $hasAnchor
     (replaceRE $anchorRE "" $raw | strings.TrimSpace)
     (replaceRE $imgRE    "" $raw | strings.TrimSpace)
-}}

<figure>
  {{- /* Render the image (or linked-image) */ -}}
  {{- if $figureElem }}
    {{ $figureElem | safeHTML }}
  {{- end }}

  {{- /* Render figcaption if there is leftover text */ -}}
  {{- if $captionHTML }}
    <figcaption>{{ $captionHTML | safeHTML }}</figcaption>
  {{- end }}
</figure>
